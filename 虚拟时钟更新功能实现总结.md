# è™šæ‹Ÿæ—¶é’Ÿæ›´æ–°åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ¯ é—®é¢˜è¯´æ˜

**ç”¨æˆ·å‘ç°**ï¼šè™½ç„¶åˆ›å»ºäº†è™šæ‹Ÿæ—¶é’Ÿç®¡ç†å™¨å’Œç›¸å…³çš„æ•°æ®ç»“æ„ï¼Œä½†å®é™…ä¸Šå¹¶æ²¡æœ‰åœ¨æ¯æ¬¡ä»»åŠ¡è°ƒåº¦æ—¶æ›´æ–°å·¥ä½œæµçš„è™šæ‹Ÿæ—¶é’Ÿã€‚

**éªŒè¯**ï¼š
- âœ… åˆ›å»ºäº† `ClockManager` ç±»
- âœ… åœ¨ `Workflow` ç±»ä¸­æ·»åŠ äº† `virtual_clock` å±æ€§
- âŒ **ä½†æ˜¯æ²¡æœ‰åœ¨ `step()` ä¸­å®é™…æ›´æ–°è™šæ‹Ÿæ—¶é’Ÿ**
- âŒ **æ²¡æœ‰åˆå§‹åŒ–æ—¶é’Ÿç®¡ç†å™¨åˆ°ç¯å¢ƒçŠ¶æ€ä¸­**

---

## âœ… å®ç°æ–¹æ¡ˆ

### 1. åœ¨ `EnvState` ä¸­æ·»åŠ  `clock_manager` å­—æ®µ

**æ–‡ä»¶**ï¼š`scheduler/rl_model/core/env/state.py`

```python
@dataclass
class EnvState:
    static_state: "StaticState"
    task_states: list["TaskState"]
    vm_states: list["VmState"]
    task_dependencies: set[tuple[int, int]]
    clock_manager: ClockManager | None = None  # æ–°å¢ï¼šè™šæ‹Ÿæ—¶é’Ÿç®¡ç†å™¨
```

### 2. åœ¨ç¯å¢ƒåˆå§‹åŒ–æ—¶åˆ›å»º `ClockManager`

**æ–‡ä»¶**ï¼š`scheduler/rl_model/core/env/gym_env.py`

åœ¨ `reset()` æ–¹æ³•ä¸­ï¼š

```python
# åˆå§‹åŒ–è™šæ‹Ÿæ—¶é’Ÿç®¡ç†å™¨
clock_manager = ClockManager()
clock_manager.initialize(dataset.workflows)  # ä¸ºæ‰€æœ‰å·¥ä½œæµåˆå§‹åŒ–è™šæ‹Ÿæ—¶é’Ÿ

# Map to the state
self.state = EnvState(
    static_state=StaticState(...),
    task_states=task_states,
    vm_states=vm_states,
    task_dependencies=dependencies,
    clock_manager=clock_manager,  # æ·»åŠ æ—¶é’Ÿç®¡ç†å™¨
)
```

### 3. åœ¨æ¯æ¬¡ `step()` ä¸­æ›´æ–°è™šæ‹Ÿæ—¶é’Ÿ

**æ–‡ä»¶**ï¼š`scheduler/rl_model/core/env/gym_env.py`

åœ¨ `step()` æ–¹æ³•ä¸­ï¼Œæ›´æ–°ä»»åŠ¡å®Œæˆåï¼š

```python
# æ›´æ–°è™šæ‹Ÿæ—¶é’Ÿï¼šæ¨è¿›å¯¹åº”å·¥ä½œæµçš„æ—¶é’Ÿ
if self.state.clock_manager is not None:
    # è·å–ä»»åŠ¡æ‰€å±çš„å·¥ä½œæµID
    workflow_id, _ = self.state.static_state.task_mapper.unmap_id(action.task_id)
    
    # æ›´æ–°å·¥ä½œæµæ—¶é’Ÿä¸ºä»»åŠ¡çš„å®Œæˆæ—¶é—´
    self.state.clock_manager.update_clock_for_task_completion(
        action.task_id, 
        new_task_states[action.task_id].completion_time
    )
```

### 4. åœ¨çŠ¶æ€æ›´æ–°æ—¶ä¼ é€’æ—¶é’Ÿç®¡ç†å™¨

**æ–‡ä»¶**ï¼š`scheduler/rl_model/core/env/gym_env.py`

```python
# Change the state
self.state = EnvState(
    static_state=self.state.static_state,
    task_states=new_task_states,
    vm_states=new_vm_states,
    task_dependencies=new_task_dependencies,
    clock_manager=self.state.clock_manager,  # ä¼ é€’æ—¶é’Ÿç®¡ç†å™¨
)
```

---

## ğŸ”„ è™šæ‹Ÿæ—¶é’Ÿæ›´æ–°æµç¨‹

```
ä»»åŠ¡åˆ†é… (step)
    â†“
è®¡ç®—ä»»åŠ¡å¼€å§‹æ—¶é—´ (start_time)
    â†“
è®¡ç®—ä»»åŠ¡å®Œæˆæ—¶é—´ (completion_time = start_time + processing_time)
    â†“
æ›´æ–°è™šæ‹Ÿæ—¶é’Ÿ: clock_manager.update_clock_for_task_completion(task_id, completion_time)
    â†“
å·¥ä½œæµæ—¶é’Ÿè¢«æ›´æ–°ä¸ºå½“å‰ä»»åŠ¡å®Œæˆæ—¶é—´
    â†“
åç»­å¯ä»¥ä½¿ç”¨å·¥ä½œæµæ—¶é’ŸæŸ¥è¯¢è¯¥æ—¶åˆ»çš„ç¢³å¼ºåº¦
```

---

## ğŸ“ å…³é”®ä¿®æ”¹ç‚¹

### ä¿®æ”¹1ï¼š`state.py`

```python
# å¯¼å…¥ClockManager
from scheduler.rl_model.core.env.clock_manager import ClockManager

# æ·»åŠ clock_managerå­—æ®µ
@dataclass
class EnvState:
    # ...
    clock_manager: ClockManager | None = None
```

### ä¿®æ”¹2ï¼š`gym_env.py`

```python
# å¯¼å…¥ClockManager
from scheduler.rl_model.core.env.clock_manager import ClockManager

# åœ¨reset()ä¸­åˆå§‹åŒ–
clock_manager = ClockManager()
clock_manager.initialize(dataset.workflows)
self.state = EnvState(..., clock_manager=clock_manager)

# åœ¨step()ä¸­æ›´æ–°
self.state.clock_manager.update_clock_for_task_completion(task_id, completion_time)

# åœ¨çŠ¶æ€æ›´æ–°æ—¶ä¼ é€’
self.state = EnvState(..., clock_manager=self.state.clock_manager)
```

---

## ğŸ¯ å·¥ä½œåŸç†

### åˆå§‹çŠ¶æ€

æ‰€æœ‰å·¥ä½œæµçš„è™šæ‹Ÿæ—¶é’Ÿä»0å¼€å§‹ï¼š

```python
workflow_0.virtual_clock = 0.0
workflow_1.virtual_clock = 0.0
workflow_2.virtual_clock = 0.0
```

### ä»»åŠ¡è°ƒåº¦è¿‡ç¨‹

```
æ­¥éª¤1ï¼šåˆ†é…å·¥ä½œæµ0çš„ä»»åŠ¡1åˆ°VM1
  - ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼š500ç§’
  - ä»»åŠ¡å®Œæˆæ—¶é—´ï¼š500ç§’
  - æ›´æ–°ï¼šworkflow_0.virtual_clock = 500.0

æ­¥éª¤2ï¼šåˆ†é…å·¥ä½œæµ1çš„ä»»åŠ¡2åˆ°VM2
  - ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼š300ç§’
  - ä»»åŠ¡å®Œæˆæ—¶é—´ï¼š300ç§’
  - æ›´æ–°ï¼šworkflow_1.virtual_clock = 300.0

æ­¥éª¤3ï¼šåˆ†é…å·¥ä½œæµ0çš„ä»»åŠ¡3åˆ°VM3
  - ä»»åŠ¡å¿…é¡»ç­‰ä»»åŠ¡1å®Œæˆï¼ˆä¾èµ–ï¼‰
  - ä»»åŠ¡å¼€å§‹æ—¶é—´ï¼šmax(VM3å®Œæˆæ—¶é—´, ä»»åŠ¡1å®Œæˆæ—¶é—´) = 500ç§’
  - ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼š200ç§’
  - ä»»åŠ¡å®Œæˆæ—¶é—´ï¼š700ç§’
  - æ›´æ–°ï¼šworkflow_0.virtual_clock = 700.0ï¼ˆå–maxï¼‰
```

---

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### è·å–å·¥ä½œæµå½“å‰æ—¶é’Ÿ

```python
# åœ¨ç¯å¢ƒä¸­çš„ä»»æ„ä½ç½®
env = CloudSchedulingGymEnvironment(dataset)
obs, info = env.reset()

# è·å–å·¥ä½œæµ0çš„å½“å‰æ—¶é’Ÿ
clock = env.state.clock_manager.get_workflow_clock(0)
print(f"å·¥ä½œæµ0çš„å½“å‰æ—¶é’Ÿ: {clock}ç§’")

# è·å–å¯¹åº”çš„å°æ—¶
hour = int(clock / 3600) % 24
print(f"å½“å‰å°æ—¶: {hour}")
```

### ä½¿ç”¨è™šæ‹Ÿæ—¶é’ŸæŸ¥è¯¢ç¢³å¼ºåº¦

```python
# è·å–å·¥ä½œæµçš„æ—¶é’Ÿ
workflow_clock = env.state.clock_manager.get_workflow_clock(workflow_id)

# æŸ¥è¯¢VMåœ¨æ­¤åˆ»çš„ç¢³å¼ºåº¦
vm_obs = obs.vm_observations[vm_id]
carbon_intensity = vm_obs.get_carbon_intensity_at(workflow_clock)
```

### åœ¨å¥–åŠ±å‡½æ•°ä¸­ä½¿ç”¨

```python
def step(self, action: int):
    # ... æ‰§è¡Œè°ƒåº¦ ...
    
    # è·å–å½“å‰å·¥ä½œæµçš„æ—¶é’Ÿ
    workflow_id = ...  # ä»ä»»åŠ¡IDè·å–
    clock = env.state.clock_manager.get_workflow_clock(workflow_id)
    
    # ä½¿ç”¨æ—¶é’Ÿè®¡ç®—ç¢³æˆæœ¬
    carbon_cost = calculate_carbon_cost(energy, host_id, clock, clock + duration)
    
    # ...
```

---

## âœ… éªŒè¯æ–¹æ³•

### æµ‹è¯•è„šæœ¬ï¼š`test_clock_manager_integration.py`

è¯¥è„šæœ¬éªŒè¯ï¼š

1. **æ—¶é’Ÿç®¡ç†å™¨åˆ›å»º**ï¼šéªŒè¯åœ¨ç¯å¢ƒåˆå§‹åŒ–æ—¶æ—¶é’Ÿç®¡ç†å™¨å·²åˆ›å»º
2. **åˆå§‹æ—¶é’Ÿä¸º0**ï¼šéªŒè¯æ‰€æœ‰å·¥ä½œæµçš„åˆå§‹æ—¶é’Ÿéƒ½æ˜¯0
3. **æ—¶é’Ÿæ›´æ–°**ï¼šéªŒè¯æ¯æ¬¡ä»»åŠ¡åˆ†é…åæ—¶é’Ÿä¼šæ›´æ–°
4. **ç¢³å¼ºåº¦æŸ¥è¯¢**ï¼šéªŒè¯å¯ä»¥ä½¿ç”¨æ›´æ–°åçš„æ—¶é’ŸæŸ¥è¯¢ç¢³å¼ºåº¦

### æ‰‹åŠ¨éªŒè¯

```python
from scheduler.rl_model.core.env.gym_env import CloudSchedulingGymEnvironment
from scheduler.dataset_generator.core.gen_dataset import generate_dataset

# åˆ›å»ºç¯å¢ƒ
dataset = generate_dataset(...)
env = CloudSchedulingGymEnvironment(dataset)

# é‡ç½®ç¯å¢ƒ
obs, info = env.reset()

# æ£€æŸ¥åˆå§‹æ—¶é’Ÿ
print("åˆå§‹æ—¶é’ŸçŠ¶æ€:")
for workflow in dataset.workflows:
    clock = env.state.clock_manager.get_workflow_clock(workflow.id)
    print(f"  å·¥ä½œæµ {workflow.id}: {clock}ç§’")

# æ‰§è¡Œå‡ æ­¥è°ƒåº¦
for step in range(5):
    # ... é€‰æ‹©åˆé€‚çš„åŠ¨ä½œ ...
    env.step(action)
    
    # æ£€æŸ¥æ—¶é’Ÿæ˜¯å¦æ›´æ–°
    print(f"\næ­¥éª¤ {step+1} å:")
    for workflow in dataset.workflows:
        clock = env.state.clock_manager.get_workflow_clock(workflow.id)
        hour = clock / 3600
        print(f"  å·¥ä½œæµ {workflow.id}: {clock:.2f}ç§’ ({hour:.2f}å°æ—¶)")
```

---

## ğŸ“Š æ—¶é—´æµç¤ºæ„å›¾

```
å·¥ä½œæµ0çš„è™šæ‹Ÿæ—¶é’Ÿ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
0s     500s             700s               1500s
 â†“       â†“                 â†“                   â†“
ä»»åŠ¡1å¼€å§‹  ä»»åŠ¡1å®Œæˆ       ä»»åŠ¡3å®Œæˆ          ä»»åŠ¡5å®Œæˆ
    â†“ ç­‰å¾…ä»»åŠ¡1  â†“      ç­‰å¾…ä»»åŠ¡3  â†“        ç­‰å¾…ä»»åŠ¡5  â†“
    [æ‰§è¡Œä»»åŠ¡1]          [æ‰§è¡Œä»»åŠ¡3]           [æ‰§è¡Œä»»åŠ¡5]
     500ç§’                200ç§’                800ç§’
     
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è™šæ‹Ÿæ—¶é’Ÿæ¨è¿›ï¼š0 â†’ 500 â†’ 700 â†’ 1500
æ¯ä¸ªä»»åŠ¡å®Œæˆåï¼Œæ—¶é’Ÿæ›´æ–°ä¸ºè¯¥ä»»åŠ¡çš„å®Œæˆæ—¶é—´
```

---

## ğŸŠ å®ç°æ€»ç»“

### å®Œæˆçš„å·¥ä½œ

1. âœ… åœ¨ `EnvState` ä¸­æ·»åŠ  `clock_manager` å­—æ®µ
2. âœ… åœ¨ç¯å¢ƒåˆå§‹åŒ–æ—¶åˆ›å»ºå’Œåˆå§‹åŒ–æ—¶é’Ÿç®¡ç†å™¨
3. âœ… åœ¨æ¯æ¬¡ä»»åŠ¡åˆ†é…æ—¶æ›´æ–°è™šæ‹Ÿæ—¶é’Ÿ
4. âœ… åœ¨çŠ¶æ€æ›´æ–°æ—¶ä¼ é€’æ—¶é’Ÿç®¡ç†å™¨
5. âœ… åˆ›å»ºæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½

### ç°åœ¨ä½ å¯ä»¥

1. **è·å–å·¥ä½œæµçš„å½“å‰æ—¶é’Ÿ**ï¼š
   ```python
   clock = env.state.clock_manager.get_workflow_clock(workflow_id)
   ```

2. **ä½¿ç”¨æ—¶é’ŸæŸ¥è¯¢ç¢³å¼ºåº¦**ï¼š
   ```python
   carbon_intensity = vm_obs.get_carbon_intensity_at(clock)
   ```

3. **åœ¨å¥–åŠ±å‡½æ•°ä¸­è®¡ç®—ç¢³æˆæœ¬**ï¼š
   ```python
   carbon_cost = obs.carbon_cost()  # å·²å®ç°
   ```

---

## ğŸ“‚ ä¿®æ”¹çš„æ–‡ä»¶

1. `scheduler/rl_model/core/env/state.py` - æ·»åŠ clock_managerå­—æ®µ
2. `scheduler/rl_model/core/env/gym_env.py` - åˆå§‹åŒ–å’Œæ›´æ–°é€»è¾‘
3. `test_clock_manager_integration.py` - æµ‹è¯•è„šæœ¬ï¼ˆæ–°å»ºï¼‰

---

## ğŸš€ ä¸‹ä¸€æ­¥

ç°åœ¨è™šæ‹Ÿæ—¶é’Ÿå·²ç»æ­£ç¡®æ›´æ–°ï¼Œä½ å¯ä»¥ï¼š

1. **ä¿®æ”¹å¥–åŠ±å‡½æ•°**ä½¿ç”¨ç¢³æˆæœ¬
2. **åœ¨GNNç‰¹å¾ä¸­**ä½¿ç”¨æ—¶é’Ÿç›¸å…³çš„ç¢³å¼ºåº¦
3. **æµ‹è¯•å’Œè®­ç»ƒ**æ¨¡å‹

æ‰€æœ‰åŸºç¡€åŠŸèƒ½å·²ç»å®Œæˆï¼ğŸ‰

