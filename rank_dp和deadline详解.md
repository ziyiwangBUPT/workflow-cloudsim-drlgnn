# rank_dp å’Œ deadline è¯¦è§£

## ğŸ“Œ æ¦‚è¿°

åœ¨é¢„è°ƒåº¦é˜¶æ®µï¼Œæˆ‘ä»¬ä¸ºæ¯ä¸ªä»»åŠ¡ï¼ˆTaskï¼‰è®¡ç®—äº†ä¸¤ä¸ªå…³é”®å±æ€§ï¼š
1. **`rank_dp`** - ä»»åŠ¡ä¼˜å…ˆçº§åˆ†æ•°
2. **`deadline`** - ä»»åŠ¡çš„å­æˆªæ­¢æ—¶é—´

è¿™ä¸¤ä¸ªå±æ€§æºè‡ªè®ºæ–‡ä¸­çš„ **Deadline Partition (DP)** ç®—æ³•ï¼Œç”¨äºæŒ‡å¯¼åç»­çš„ä»»åŠ¡è°ƒåº¦å†³ç­–ã€‚

---

## ğŸ¯ 1. rank_dpï¼ˆä»»åŠ¡ä¼˜å…ˆçº§åˆ†æ•°ï¼‰

### å®šä¹‰

`rank_dp` æ˜¯ä¸€ä¸ª**æ•°å€¼å‹ä¼˜å…ˆçº§åˆ†æ•°**ï¼Œè¡¨ç¤ºä»»åŠ¡åœ¨å·¥ä½œæµä¸­çš„**å…³é”®ç¨‹åº¦**å’Œ**ç´§è¿«æ€§**ã€‚

### è®¡ç®—æ–¹æ³•

`rank_dp` é‡‡ç”¨**è‡ªåº•å‘ä¸Šï¼ˆä»å‡ºå£åˆ°å…¥å£ï¼‰çš„é€’å½’è®¡ç®—**ï¼š

```python
# ä¼ªä»£ç 
å¯¹äºæ¯ä¸ªä»»åŠ¡ taskï¼ˆæŒ‰é€†æ‹“æ‰‘åºéå†ï¼‰:
    if task æ˜¯å‡ºå£ä»»åŠ¡ï¼ˆæ²¡æœ‰åç»§ï¼‰:
        rank_dp[task] = avg_worktime[task]
    else:
        max_child_rank = max(rank_dp[child] for child in taskçš„åç»§ä»»åŠ¡)
        rank_dp[task] = max_child_rank + avg_worktime[task]
```

### å«ä¹‰è§£é‡Š

**rank_dp è¶Šå¤§ â†’ ä»»åŠ¡è¶Šå…³é”®/ç´§è¿«**

`rank_dp` å®é™…ä¸Šè¡¨ç¤ºï¼š
- **ä»å½“å‰ä»»åŠ¡åˆ°å·¥ä½œæµå‡ºå£çš„æœ€é•¿è·¯å¾„é•¿åº¦**ï¼ˆä»¥æ‰§è¡Œæ—¶é—´è®¡ï¼‰
- ç±»ä¼¼äºå…³é”®è·¯å¾„æ³•ï¼ˆCPMï¼‰ä¸­çš„"æœ€æ™šå¼€å§‹æ—¶é—´"çš„å€’æ•°

### ä¸¾ä¾‹è¯´æ˜

å‡è®¾æœ‰ä¸€ä¸ªç®€å•çš„å·¥ä½œæµï¼š

```
Task A (100ms) â†’ Task B (50ms) â†’ Task D (30ms)
       â†“
Task C (80ms) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ Task D (30ms)
```

è®¡ç®—è¿‡ç¨‹ï¼ˆä»åå‘å‰ï¼‰ï¼š
1. **Task D**ï¼ˆå‡ºå£ä»»åŠ¡ï¼‰ï¼š
   ```
   rank_dp[D] = avg_worktime[D] = 30
   ```

2. **Task B**ï¼š
   ```
   rank_dp[B] = rank_dp[D] + avg_worktime[B]
              = 30 + 50 = 80
   ```

3. **Task C**ï¼š
   ```
   rank_dp[C] = rank_dp[D] + avg_worktime[C]
              = 30 + 80 = 110
   ```

4. **Task A**ï¼ˆå…¥å£ä»»åŠ¡ï¼‰ï¼š
   ```
   rank_dp[A] = max(rank_dp[B], rank_dp[C]) + avg_worktime[A]
              = max(80, 110) + 100
              = 110 + 100 = 210
   ```

**ç»“è®º**ï¼šTask A çš„ rank_dp æœ€é«˜ï¼ˆ210ï¼‰ï¼Œå› ä¸ºå®ƒåœ¨å…³é”®è·¯å¾„ä¸Šä¸”è·ç¦»å‡ºå£æœ€è¿œã€‚

### ç”¨é€”

åœ¨ PPO å¼ºåŒ–å­¦ä¹ è°ƒåº¦ä¸­ï¼Œ`rank_dp` å¯ç”¨äºï¼š

1. **ä»»åŠ¡ä¼˜å…ˆçº§æ’åº**ï¼š
   ```python
   # rank_dp è¶Šå¤§çš„ä»»åŠ¡è¶Šä¼˜å…ˆè°ƒåº¦
   sorted_tasks = sorted(tasks, key=lambda t: t.rank_dp, reverse=True)
   ```

2. **çŠ¶æ€ç‰¹å¾**ï¼š
   ```python
   # ä½œä¸ºç¥ç»ç½‘ç»œçš„è¾“å…¥ç‰¹å¾
   task_features = [task.rank_dp, task.length, task.req_memory_mb, ...]
   ```

3. **å¥–åŠ±å‡½æ•°è®¾è®¡**ï¼š
   ```python
   # ä¼˜å…ˆè°ƒåº¦é«˜ rank_dp çš„ä»»åŠ¡å¯ä»¥è·å¾—æ›´å¤šå¥–åŠ±
   reward = -task.rank_dp * delay_time
   ```

---

## â° 2. deadlineï¼ˆä»»åŠ¡å­æˆªæ­¢æ—¶é—´ï¼‰

### å®šä¹‰

`deadline` æ˜¯ä¸ºæ¯ä¸ªä»»åŠ¡åˆ†é…çš„**å­æˆªæ­¢æ—¶é—´**ï¼Œè¡¨ç¤ºè¯¥ä»»åŠ¡åº”è¯¥åœ¨ä»€ä¹ˆæ—¶é—´ç‚¹ä¹‹å‰å®Œæˆã€‚

### è®¡ç®—æ–¹æ³•

åŸºäº `rank_dp` å’Œå·¥ä½œæµçš„æ€»æˆªæ­¢æ—¶é—´ `workflow.deadline` è®¡ç®—ï¼š

```python
# è®¡ç®—å…¬å¼
rank_dp_0 = max(rank_dp[å…¥å£ä»»åŠ¡])  # å…¥å£ä»»åŠ¡çš„æœ€å¤§ rank_dp

å¯¹äºæ¯ä¸ªä»»åŠ¡ task:
    task.deadline = workflow.deadline * (rank_dp_0 - rank_dp[task] + avg_worktime[task]) / rank_dp_0
```

### å«ä¹‰è§£é‡Š

è¿™ä¸ªå…¬å¼çš„è®¾è®¡æ€æƒ³ï¼š

1. **æ¯”ä¾‹åˆ†é…**ï¼šæ ¹æ®ä»»åŠ¡åœ¨å…³é”®è·¯å¾„ä¸Šçš„ä½ç½®ï¼ŒæŒ‰æ¯”ä¾‹åˆ†é…æ—¶é—´
2. **å…¬å¹³æ€§**ï¼šç¡®ä¿æ‰€æœ‰ä»»åŠ¡çš„æ—¶é—´åˆ†é…ä¸å…¶é‡è¦æ€§æˆæ­£æ¯”
3. **çº¦æŸæ€§**ï¼šå…¥å£ä»»åŠ¡çš„ deadline æ¥è¿‘ 0ï¼Œå‡ºå£ä»»åŠ¡çš„ deadline æ¥è¿‘ workflow.deadline

### ä¸¾ä¾‹è¯´æ˜

ç»§ç»­ä¸Šé¢çš„ä¾‹å­ï¼Œå‡è®¾ `workflow.deadline = 300ms`ï¼š

```
rank_dp_0 = 210ï¼ˆTask A çš„ rank_dpï¼‰
```

è®¡ç®—å„ä»»åŠ¡çš„ deadlineï¼š

1. **Task A**ï¼ˆå…¥å£ä»»åŠ¡ï¼‰ï¼š
   ```
   deadline[A] = 300 * (210 - 210 + 100) / 210
               = 300 * 100 / 210
               = 142.86 ms
   ```

2. **Task B**ï¼š
   ```
   deadline[B] = 300 * (210 - 80 + 50) / 210
               = 300 * 180 / 210
               = 257.14 ms
   ```

3. **Task C**ï¼š
   ```
   deadline[C] = 300 * (210 - 110 + 80) / 210
               = 300 * 180 / 210
               = 257.14 ms
   ```

4. **Task D**ï¼ˆå‡ºå£ä»»åŠ¡ï¼‰ï¼š
   ```
   deadline[D] = 300 * (210 - 30 + 30) / 210
               = 300 * 210 / 210
               = 300 ms
   ```

**è§‚å¯Ÿ**ï¼š
- Task Aï¼ˆå…¥å£ï¼‰çš„ deadline = 142.86msï¼ˆæœ€æ—©ï¼‰
- Task Dï¼ˆå‡ºå£ï¼‰çš„ deadline = 300msï¼ˆæœ€æ™šï¼Œç­‰äºå·¥ä½œæµæˆªæ­¢æ—¶é—´ï¼‰
- Task B å’Œ C çš„ deadline åœ¨ä¸­é—´

### ç”¨é€”

åœ¨ PPO å¼ºåŒ–å­¦ä¹ è°ƒåº¦ä¸­ï¼Œ`deadline` å¯ç”¨äºï¼š

1. **ç¡¬çº¦æŸ**ï¼š
   ```python
   # æ£€æŸ¥ä»»åŠ¡æ˜¯å¦è¶…æœŸ
   if task.finish_time > task.deadline:
       penalty = -1000  # è¶…æœŸæƒ©ç½š
   ```

2. **è½¯çº¦æŸï¼ˆå¥–åŠ±å‡½æ•°ï¼‰**ï¼š
   ```python
   # æ ¹æ®æ˜¯å¦åœ¨ deadline å†…å®Œæˆç»™äºˆä¸åŒå¥–åŠ±
   tardiness = max(0, task.finish_time - task.deadline)
   reward = -tardiness  # è¶Šæ¥è¿‘ deadline å®Œæˆï¼Œå¥–åŠ±è¶Šé«˜
   ```

3. **ç´§è¿«æ€§åº¦é‡**ï¼š
   ```python
   # è®¡ç®—ä»»åŠ¡çš„ç´§è¿«ç¨‹åº¦
   urgency = (task.deadline - current_time) / task.avg_worktime
   # urgency è¶Šå°è¡¨ç¤ºè¶Šç´§è¿«
   ```

4. **å†³ç­–ä¼˜å…ˆçº§**ï¼š
   ```python
   # ä¼˜å…ˆè°ƒåº¦ deadline ç´§è¿«çš„ä»»åŠ¡
   sorted_tasks = sorted(tasks, key=lambda t: t.deadline)
   ```

---

## ğŸ”— 3. rank_dp å’Œ deadline çš„å…³ç³»

### å…³é”®å…³ç³»

1. **åå‘å…³ç³»**ï¼š
   - `rank_dp` è¶Šå¤§ â†’ `deadline` è¶Šå°ï¼ˆè¶Šæ—©ï¼‰
   - `rank_dp` è¶Šå° â†’ `deadline` è¶Šå¤§ï¼ˆè¶Šæ™šï¼‰

2. **äº’è¡¥æ€§**ï¼š
   - `rank_dp` è¡¨ç¤º"ä»å‰å¾€åçœ‹"çš„é‡è¦æ€§
   - `deadline` è¡¨ç¤º"ä»åå¾€å‰çœ‹"çš„æ—¶é—´çº¦æŸ

3. **ååŒä½œç”¨**ï¼š
   ```python
   # ç»¼åˆä¸¤ä¸ªæŒ‡æ ‡è¿›è¡Œè°ƒåº¦å†³ç­–
   priority = Î± * rank_dp + Î² * (1 / (deadline - current_time))
   ```

### ç›´è§‚ç†è§£

æƒ³è±¡ä¸€ä¸ªå·¥ä½œæµæ˜¯ä¸€æ¡ç”Ÿäº§çº¿ï¼š

- **rank_dp**ï¼šè¡¨ç¤ºè¿™ä¸ªä»»åŠ¡"å½±å“ä¸‹æ¸¸çš„ç¨‹åº¦"
  - å…¥å£ä»»åŠ¡å½±å“æ•´æ¡ç”Ÿäº§çº¿ â†’ rank_dp æœ€å¤§
  - å‡ºå£ä»»åŠ¡åªå½±å“è‡ªå·± â†’ rank_dp æœ€å°

- **deadline**ï¼šè¡¨ç¤ºè¿™ä¸ªä»»åŠ¡"å¿…é¡»å®Œæˆçš„æ—¶é—´ç‚¹"
  - å…¥å£ä»»åŠ¡å¿…é¡»å°½æ—©å¼€å§‹ â†’ deadline æœ€å°
  - å‡ºå£ä»»åŠ¡å¯ä»¥æœ€æ™šå®Œæˆ â†’ deadline æœ€å¤§ï¼ˆ=å·¥ä½œæµdeadlineï¼‰

---

## ğŸ“Š 4. å®é™…æµ‹è¯•æ•°æ®ç¤ºä¾‹

ä» `test_pre_scheduling.py` çš„è¾“å‡ºï¼š

```
ä»»åŠ¡ 0:
   - length: 509
   - avg_est: 0.00
   - avg_eft: 0.25
   - rank_dp: 0.71      â† ä¼˜å…ˆçº§åˆ†æ•°ï¼ˆå…³é”®è·¯å¾„é•¿åº¦ï¼‰
   - deadline: 0.30     â† å­æˆªæ­¢æ—¶é—´
   - parent_ids: []     â† å…¥å£ä»»åŠ¡
   - child_ids: [1, 2, 3, 4, 5]

ä»»åŠ¡ 1:
   - length: 502
   - avg_est: 0.25
   - avg_eft: 0.50
   - rank_dp: 0.25      â† è¾ƒå°çš„ rank_dpï¼ˆéå…³é”®è·¯å¾„ï¼‰
   - deadline: 0.86     â† è¾ƒå¤§çš„ deadlineï¼ˆæ›´å®½æ¾ï¼‰
   - parent_ids: [0]
   - child_ids: []      â† å‡ºå£ä»»åŠ¡
```

**åˆ†æ**ï¼š
- Task 0 æ˜¯å…¥å£ä»»åŠ¡ï¼šrank_dp = 0.71ï¼ˆé«˜ï¼‰, deadline = 0.30ï¼ˆç´§ï¼‰
- Task 1 æ˜¯å‡ºå£ä»»åŠ¡ï¼šrank_dp = 0.25ï¼ˆä½ï¼‰, deadline = 0.86ï¼ˆæ¾ï¼‰
- è¿™ç¬¦åˆé¢„æœŸï¼šå…¥å£ä»»åŠ¡æ›´å…³é”®ä½†å¿…é¡»æ›´æ—©å®Œæˆ

---

## ğŸ“ 5. ç†è®ºæ¥æº

è¿™ä¸¤ä¸ªæ¦‚å¿µæ¥è‡ªè®ºæ–‡ä¸­çš„è°ƒåº¦ç®—æ³•ï¼š

1. **rank_dp** ç±»ä¼¼äº HEFT ç®—æ³•ä¸­çš„ "upward rank"
   - è¡¨ç¤ºä»»åŠ¡åˆ°å‡ºå£çš„æœ€é•¿è·¯å¾„
   - ç”¨äºç¡®å®šä»»åŠ¡çš„è°ƒåº¦ä¼˜å…ˆçº§

2. **deadline** åŸºäºæˆªæ­¢æ—¶é—´åˆ’åˆ†ï¼ˆDeadline Partitionï¼‰
   - å°†å·¥ä½œæµçš„æ€»æˆªæ­¢æ—¶é—´å…¬å¹³åœ°åˆ†é…ç»™å„ä¸ªä»»åŠ¡
   - è€ƒè™‘äº†ä»»åŠ¡çš„å…³é”®ç¨‹åº¦å’Œæ‰§è¡Œæ—¶é—´

---

## ğŸ’¡ 6. å¦‚ä½•åœ¨ PPO ä¸­ä½¿ç”¨

### æ–¹æ¡ˆ 1: ä½œä¸ºçŠ¶æ€ç‰¹å¾

```python
def get_state_features(task):
    return np.array([
        task.rank_dp / max_rank_dp,        # å½’ä¸€åŒ–ä¼˜å…ˆçº§
        (task.deadline - current_time) / max_time,  # å½’ä¸€åŒ–å‰©ä½™æ—¶é—´
        task.length / max_length,
        task.req_memory_mb / max_memory,
        # ... å…¶ä»–ç‰¹å¾
    ])
```

### æ–¹æ¡ˆ 2: ä½œä¸ºå¥–åŠ±å‡½æ•°

```python
def compute_reward(task, finish_time):
    # åŸºäº deadline çš„æƒ©ç½š
    tardiness = max(0, finish_time - task.deadline)
    deadline_penalty = -tardiness * 10
    
    # åŸºäº rank_dp çš„æƒé‡
    importance_weight = task.rank_dp / max_rank_dp
    
    # ç»¼åˆå¥–åŠ±
    reward = deadline_penalty * importance_weight
    return reward
```

### æ–¹æ¡ˆ 3: ä½œä¸ºå¯å‘å¼å…ˆéªŒ

```python
def get_action_mask(ready_tasks):
    # ä¼˜å…ˆé€‰æ‹© rank_dp é«˜ä¸” deadline ç´§è¿«çš„ä»»åŠ¡
    sorted_tasks = sorted(ready_tasks, 
                         key=lambda t: (t.rank_dp, -t.deadline),
                         reverse=True)
    return sorted_tasks[:top_k]  # åªè€ƒè™‘å‰ k ä¸ªå€™é€‰
```

---

## ğŸ“ æ€»ç»“

| å±æ€§ | å«ä¹‰ | è®¡ç®—æ–¹å¼ | å…¸å‹å€¼èŒƒå›´ | ç”¨é€” |
|-----|------|---------|-----------|------|
| **rank_dp** | ä»»åŠ¡ä¼˜å…ˆçº§åˆ†æ•°<br/>ï¼ˆå…³é”®è·¯å¾„é•¿åº¦ï¼‰ | è‡ªåº•å‘ä¸Šé€’å½’<br/>ç´¯åŠ æ‰§è¡Œæ—¶é—´ | å…¥å£å¤§ï¼Œå‡ºå£å° | ä»»åŠ¡æ’åº<br/>çŠ¶æ€ç‰¹å¾<br/>å¥–åŠ±æƒé‡ |
| **deadline** | ä»»åŠ¡å­æˆªæ­¢æ—¶é—´ | åŸºäº rank_dp<br/>æŒ‰æ¯”ä¾‹åˆ†é… | å…¥å£å°ï¼Œå‡ºå£å¤§<br/>ï¼ˆ=workflow.deadlineï¼‰ | æ—¶é—´çº¦æŸ<br/>ç´§è¿«æ€§åº¦é‡<br/>å¥–åŠ±æƒ©ç½š |

**æ ¸å¿ƒæ€æƒ³**ï¼šé€šè¿‡è¿™ä¸¤ä¸ªå±æ€§ï¼Œä¸º PPO agent æä¾›äº†"å“ªäº›ä»»åŠ¡æ›´é‡è¦"å’Œ"ä»€ä¹ˆæ—¶å€™å¿…é¡»å®Œæˆ"çš„ä¿¡æ¯ï¼Œä»è€Œåšå‡ºæ›´å¥½çš„è°ƒåº¦å†³ç­–ï¼

