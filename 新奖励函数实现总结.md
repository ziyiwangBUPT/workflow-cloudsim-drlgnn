# æ–°å¥–åŠ±å‡½æ•°å®ç°æ€»ç»“ï¼ˆå‚è€ƒ ecmws æ¨¡å¼ï¼‰

## ğŸ“‹ æ¦‚è¿°

æˆåŠŸå°† paper1115 çš„å¥–åŠ±å‡½æ•°ä»"æ”¹å–„é‡å½’ä¸€åŒ–æ¨¡å¼"æ”¹ä¸º"ecmws é£æ ¼çš„çœŸå®å€¼+æƒ©ç½šæ¨¡å¼"ã€‚

## ğŸ¯ æ ¸å¿ƒå˜åŒ–

### æ—§å¥–åŠ±å‡½æ•°ï¼ˆæ”¹å–„é‡å½’ä¸€åŒ–ï¼‰
```python
# æ—§ç‰ˆæœ¬
makespan_reward = -(obs.makespan() - prev_obs.makespan()) / obs.makespan()
carbon_reward = -(obs.carbon_cost() - prev_obs.carbon_cost()) / obs.carbon_cost()
reward = makespan_reward + carbon_reward
```

**é—®é¢˜**ï¼š
- å¥–åŠ±æ˜¯ç›¸å¯¹æ”¹å–„é‡ï¼Œä¸æ˜¯ç»å¯¹å€¼
- makespan å’Œ carbon éƒ½è¦å½’ä¸€åŒ–
- éš¾ä»¥ç›´æ¥åæ˜ çœŸå®æˆæœ¬

### æ–°å¥–åŠ±å‡½æ•°ï¼ˆecmws æ¨¡å¼ï¼‰
```python
# æ–°ç‰ˆæœ¬
task_obs = obs.task_observations[task_id]  # è·å–å½“å‰è°ƒåº¦çš„ä»»åŠ¡

# åŸºç¡€å¥–åŠ±ï¼šè´Ÿçš„ç¢³æˆæœ¬ï¼ˆçœŸå®å€¼ï¼‰
reward = -task_obs.carbon_cost

# Deadline æƒ©ç½š
delta = task_obs.completion_time - task_obs.deadline
if delta > 0:  # è¶…æ—¶
    duration = task_obs.completion_time - task_obs.start_time
    reward = reward * (1.0 + delta / duration)  # å¢åŠ æƒ©ç½š
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç›´æ¥ä½¿ç”¨çœŸå®ç¢³æˆæœ¬å€¼ï¼ˆgCO2ï¼‰
- âœ… è¶…æ—¶æƒ©ç½šæœºåˆ¶ï¼ˆç±»ä¼¼ ecmwsï¼‰
- âœ… å¥–åŠ±ä¿¡å·æ›´ç›´è§‚
- âœ… ç¬¦åˆå®é™…ä¼˜åŒ–ç›®æ ‡

## ğŸ“Š ecmws å¥–åŠ±å‡½æ•°åˆ†æ

### ecmws åŸå§‹ä»£ç 
```python
def reward_fn(task_execution):
    task = task_execution.task
    delta = task.finish_time - task.deadline
    reward = - task_execution.electricity_cost  # è´Ÿçš„ç”µä»·æˆæœ¬
    if delta <= 0:
        return reward  # æŒ‰æ—¶å®Œæˆ
    else:
        return reward * (1 + delta / (task.finish_time - task.start_time))  # è¶…æ—¶æƒ©ç½š
```

### paper1115 å®ç°å¯¹åº”
```python
# paper1115 ç‰ˆæœ¬
task_obs = obs.task_observations[task_id]
carbon_cost = task_obs.carbon_cost
reward = -carbon_cost  # å¯¹åº” -electricity_cost

delta = task_obs.completion_time - task_obs.deadline
if delta > 0:
    duration = task_obs.completion_time - task_obs.start_time
    reward = reward * (1.0 + delta / duration)  # å¯¹åº”è¶…æ—¶æƒ©ç½š
```

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. ç¢³å¼ºåº¦æ•°å€¼è°ƒæ•´

**æ–‡ä»¶**: `scheduler/config/carbon_intensity.py`

ç¢³å¼ºåº¦æ•°å€¼æ”¾å¤§1000å€ï¼ˆç”¨æˆ·å·²ä¿®æ”¹ï¼‰ï¼š
```python
# æ—§å€¼ï¼ˆgCO2/kWhï¼‰
host1 = [0.15, 0.10, 0.11, ...]  

# æ–°å€¼ï¼ˆæ”¾å¤§1000å€ï¼‰
host1 = [1500, 1000, 1100, ...]  
```

**åŸå› **: ä½¿ç¢³æˆæœ¬çš„ç»å¯¹å€¼æ›´æœ‰æ„ä¹‰ï¼Œæ–¹ä¾¿è®­ç»ƒ

### 2. å¥–åŠ±å‡½æ•°ä¿®æ”¹

**æ–‡ä»¶**: `scheduler/rl_model/agents/gin_agent/wrapper.py`

ä¿®æ”¹ `step()` æ–¹æ³•ï¼š
- ç§»é™¤ makespan å¥–åŠ±ï¼ˆä¸å†å…³æ³¨å®Œå·¥æ—¶é—´æ”¹å–„ï¼‰
- ç§»é™¤ç¢³æˆæœ¬å½’ä¸€åŒ–
- æ·»åŠ  deadline è¶…æ—¶æƒ©ç½š

```python
def step(self, action: int) -> tuple[np.ndarray, SupportsFloat, bool, bool, dict[str, Any]]:
    mapped_action = self.map_action(action)
    obs, _, terminated, truncated, info = super().step(mapped_action)
    
    # è·å–å½“å‰è°ƒåº¦çš„ä»»åŠ¡
    task_id = mapped_action.task_id
    task_obs = obs.task_observations[task_id]
    
    # åŸºç¡€å¥–åŠ±ï¼š-ç¢³æˆæœ¬
    reward = -task_obs.carbon_cost
    
    # Deadline æƒ©ç½š
    delta = task_obs.completion_time - task_obs.deadline
    if delta > 0:
        duration = task_obs.completion_time - task_obs.start_time
        if duration > 0:
            reward = reward * (1.0 + delta / duration)
    
    return mapped_obs, reward, terminated, truncated, info
```

## ğŸ“ˆ å¥–åŠ±å‡½æ•°å…¬å¼

### åŸºæœ¬å…¬å¼
```
reward = -carbon_cost Ã— penalty_factor

å…¶ä¸­ï¼š
  carbon_cost = ä»»åŠ¡ç¢³æˆæœ¬ï¼ˆgCO2ï¼ŒçœŸå®å€¼ï¼‰
  
  penalty_factor = {
    1.0,                        if æŒ‰æ—¶å®Œæˆï¼ˆdelta <= 0ï¼‰
    1.0 + delta / duration,     if è¶…æ—¶ï¼ˆdelta > 0ï¼‰
  }
  
  delta = completion_time - deadline  # è¶…æ—¶æ—¶é—´
  duration = completion_time - start_time  # ä»»åŠ¡æ‰§è¡Œæ—¶é•¿
```

### å¥–åŠ±ç‰¹æ€§

1. **åŸºç¡€å¥–åŠ±å§‹ç»ˆä¸ºè´Ÿ** - å› ä¸ºç¢³æˆæœ¬æ˜¯æƒ©ç½š
2. **æŒ‰æ—¶å®Œæˆ** - reward = -carbon_costï¼ˆè´Ÿå€¼ä½†è¾ƒå°ï¼‰
3. **è¶…æ—¶å®Œæˆ** - reward å˜å¾—æ›´è´Ÿï¼ˆæƒ©ç½šåŠ é‡ï¼‰
4. **è¶…æ—¶è¶Šå¤šï¼Œæƒ©ç½šè¶Šå¤§** - penalty_factor éš delta å¢é•¿

### ç¤ºä¾‹è®¡ç®—

**æƒ…å†µ1ï¼šæŒ‰æ—¶å®Œæˆ**
```
carbon_cost = 0.05 gCO2
completion_time = 100s
deadline = 120s
delta = 100 - 120 = -20s  # æå‰å®Œæˆ

reward = -0.05  # ä»…ç¢³æˆæœ¬æƒ©ç½š
```

**æƒ…å†µ2ï¼šè½»å¾®è¶…æ—¶**
```
carbon_cost = 0.05 gCO2
start_time = 50s
completion_time = 130s
deadline = 120s
delta = 130 - 120 = 10s  # è¶…æ—¶10ç§’
duration = 130 - 50 = 80s

penalty_factor = 1.0 + 10/80 = 1.125
reward = -0.05 Ã— 1.125 = -0.05625  # æƒ©ç½šåŠ é‡12.5%
```

**æƒ…å†µ3ï¼šä¸¥é‡è¶…æ—¶**
```
carbon_cost = 0.05 gCO2
start_time = 50s
completion_time = 150s
deadline = 120s
delta = 150 - 120 = 30s  # è¶…æ—¶30ç§’
duration = 150 - 50 = 100s

penalty_factor = 1.0 + 30/100 = 1.3
reward = -0.05 Ã— 1.3 = -0.065  # æƒ©ç½šåŠ é‡30%
```

## âœ… æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬

1. **test_new_reward_function.py** - æ–°å¥–åŠ±å‡½æ•°é€»è¾‘æµ‹è¯•
   - æµ‹è¯•1ï¼šå¥–åŠ±è®¡ç®—é€»è¾‘
   - æµ‹è¯•2ï¼šDeadline æƒ©ç½šæœºåˆ¶
   - æµ‹è¯•3ï¼šç¢³æˆæœ¬æ•°å€¼èŒƒå›´

2. **train_mini_batch.py** - å°æ‰¹æ¬¡è®­ç»ƒéªŒè¯
   - æµ‹è¯•è®­ç»ƒå¾ªç¯
   - æµ‹è¯•å¥–åŠ±æ¢¯åº¦
   - éªŒè¯ç¯å¢ƒæ­£å¸¸è¿è¡Œ

### è¿è¡Œæµ‹è¯•

```bash
# éœ€è¦å…ˆå®‰è£… gymnasium
pip install gymnasium==0.28.1

# è¿è¡Œå¥–åŠ±å‡½æ•°æµ‹è¯•
python test_new_reward_function.py

# è¿è¡Œè®­ç»ƒéªŒè¯
python train_mini_batch.py
```

## ğŸ” ä¸ ecmws çš„å¯¹æ¯”

| ç‰¹æ€§ | ecmws | paper1115 (æ–°) |
|------|-------|----------------|
| ä¼˜åŒ–ç›®æ ‡ | ç”µä»·æˆæœ¬ | ç¢³æˆæœ¬ |
| åŸºç¡€å¥–åŠ± | -electricity_cost | -carbon_cost |
| æ—¶é—´çº¦æŸ | task.deadline | task.deadline (DPç®—æ³•ç”Ÿæˆ) |
| è¶…æ—¶æƒ©ç½š | âœ… | âœ… (åŒæ ·çš„å…¬å¼) |
| å½’ä¸€åŒ– | âŒ (çœŸå®å€¼) | âŒ (çœŸå®å€¼) |
| æƒ©ç½šå› å­ | 1 + delta/duration | 1 + delta/duration |

## ğŸ“Œ å…³é”®è¦ç‚¹

### 1. å¥–åŠ±æ˜¯è´Ÿå€¼
- æ‰€æœ‰å¥–åŠ±éƒ½ â‰¤ 0ï¼ˆæˆæœ¬/æƒ©ç½šï¼‰
- æŒ‰æ—¶å®Œæˆï¼šè¾ƒå°çš„è´Ÿå€¼
- è¶…æ—¶ï¼šæ›´å¤§çš„è´Ÿå€¼

### 2. Deadline æ¥æº
- ç”±é¢„è°ƒåº¦é˜¶æ®µçš„ DP (Deadline Partition) ç®—æ³•ç”Ÿæˆ
- æ¯ä¸ªä»»åŠ¡æœ‰è‡ªå·±çš„å­æˆªæ­¢æ—¶é—´
- å­˜å‚¨åœ¨ `task.deadline` ä¸­

### 3. ç¢³æˆæœ¬è®¡ç®—
- åœ¨ `gym_env.py` çš„ `step()` ä¸­è‡ªåŠ¨è®¡ç®—
- å…¬å¼ï¼š`carbon_cost = energy(kWh) Ã— avg_carbon_intensity(gCO2/kWh)`
- ä¿å­˜åœ¨ `task_state.carbon_cost` ä¸­

### 4. è®­ç»ƒæ„ä¹‰
- æ™ºèƒ½ä½“å­¦ä¹ é€‰æ‹©ä½ç¢³æˆæœ¬çš„ VM
- æ™ºèƒ½ä½“å­¦ä¹ é¿å…è¶…æ—¶ï¼ˆdeadline çº¦æŸï¼‰
- å¹³è¡¡ç¢³æˆæœ¬å’Œå®Œæˆæ—¶é—´

## ğŸš€ ä¸‹ä¸€æ­¥

### å¼€å§‹æ­£å¼è®­ç»ƒ

1. **å®‰è£…ä¾èµ–**ï¼š
   ```bash
   pip install gymnasium==0.28.1
   ```

2. **è¿è¡Œè®­ç»ƒè„šæœ¬**ï¼ˆä½ çš„æ­£å¼è®­ç»ƒä»£ç ï¼‰

3. **ç›‘æ§æŒ‡æ ‡**ï¼š
   - å¹³å‡å¥–åŠ±ï¼ˆåº”è¯¥é€æ¸å¢å¤§ï¼Œæ¥è¿‘0ï¼‰
   - æ€»ç¢³æˆæœ¬ï¼ˆåº”è¯¥é€æ¸å‡å°ï¼‰
   - æŒ‰æ—¶å®Œæˆç‡ï¼ˆåº”è¯¥é€æ¸æé«˜ï¼‰

### å¯èƒ½çš„è°ƒæ•´

1. **å¥–åŠ±æƒé‡**ï¼ˆå¦‚éœ€è¦ï¼‰ï¼š
   ```python
   # åœ¨ wrapper.py ä¸­
   reward = -alpha * carbon_cost  # alphaè°ƒæ•´ç¢³æˆæœ¬æƒé‡
   ```

2. **æƒ©ç½šå¼ºåº¦**ï¼ˆå¦‚éœ€è¦ï¼‰ï¼š
   ```python
   # è°ƒæ•´è¶…æ—¶æƒ©ç½šçš„å¼ºåº¦
   penalty_factor = 1.0 + beta * (delta / duration)  # betaè°ƒæ•´æƒ©ç½šå¼ºåº¦
   ```

3. **ç¢³å¼ºåº¦æ•°å€¼**ï¼š
   - å¯ä»¥ä½¿ç”¨çœŸå®æ•°æ®
   - å¯ä»¥è°ƒæ•´æ•°å€¼èŒƒå›´ä»¥é€‚åº”è®­ç»ƒ

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. âœ… `scheduler/config/carbon_intensity.py` - ç¢³å¼ºåº¦æ•°å€¼ï¼ˆç”¨æˆ·å·²ä¿®æ”¹ï¼‰
2. âœ… `scheduler/rl_model/agents/gin_agent/wrapper.py` - å¥–åŠ±å‡½æ•°
3. âœ… `test_new_reward_function.py` - å¥–åŠ±å‡½æ•°æµ‹è¯•
4. âœ… `train_mini_batch.py` - è®­ç»ƒéªŒè¯è„šæœ¬

## ğŸ’¡ è®­ç»ƒå»ºè®®

1. **åˆæœŸè®­ç»ƒ**ï¼š
   - ä½¿ç”¨å°çš„æ•°æ®é›†ï¼ˆå°‘é‡å·¥ä½œæµå’Œä»»åŠ¡ï¼‰
   - çŸ­ episodeï¼ˆå¿«é€ŸéªŒè¯ï¼‰
   - è§‚å¯Ÿå¥–åŠ±è¶‹åŠ¿

2. **è°ƒè¯•**ï¼š
   - å¦‚æœå¥–åŠ±ä¸æ”¶æ•›ï¼Œæ£€æŸ¥ç¢³æˆæœ¬æ•°å€¼æ˜¯å¦åˆç†
   - å¦‚æœè¶…æ—¶ç‡å¤ªé«˜ï¼Œè€ƒè™‘è°ƒæ•´ deadline ç”Ÿæˆå‚æ•°
   - å¦‚æœè®­ç»ƒä¸ç¨³å®šï¼Œè€ƒè™‘æ·»åŠ å¥–åŠ±å‰ªè£

3. **æ­£å¼è®­ç»ƒ**ï¼š
   - å¢å¤§æ•°æ®é›†
   - å¢åŠ è®­ç»ƒæ­¥æ•°
   - ä½¿ç”¨å¤šä¸ªç¯å¢ƒå¹¶è¡Œè®­ç»ƒ

---

**å®ç°æ—¶é—´**: 2025å¹´10æœˆ29æ—¥  
**å®ç°çŠ¶æ€**: âœ… å®Œæˆï¼Œå¾…è¿è¡Œæµ‹è¯•éªŒè¯
**å‚è€ƒé¡¹ç›®**: ecmws-experiments

