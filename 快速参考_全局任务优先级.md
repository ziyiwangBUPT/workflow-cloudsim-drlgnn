# å¿«é€Ÿå‚è€ƒï¼šå…¨å±€ä»»åŠ¡ä¼˜å…ˆçº§

## ğŸ¯ æ ¸å¿ƒæ”¹åŠ¨

### 1. æ–°å¢å­—æ®µ

**Workflow**ï¼š
```python
workflow.workflow_priority  # å·¥ä½œæµä¼˜å…ˆçº§åˆ†æ•°ï¼ˆè¶Šå°è¶Šé«˜ï¼‰
```

**Task**ï¼š
```python
task.global_priority  # å…¨å±€ä»»åŠ¡ä¼˜å…ˆçº§ = workflow_priority Ã— rank_dp
```

---

## ğŸ“– ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šè·å–å·¥ä½œæµä¼˜å…ˆçº§

```python
from scheduler.dataset_generator.core.gen_dataset import generate_dataset
from scheduler.pre_scheduling.pre_computation import precompute_workflow_data
from scheduler.pre_scheduling.ws_method import ContentionAwareWorkflowSequencing

# ç”Ÿæˆæ•°æ®é›†
dataset = generate_dataset(...)

# é¢„è®¡ç®—
for workflow in dataset.workflows:
    precompute_workflow_data(workflow, dataset.vms, rho=0.2)

# è®¡ç®—å·¥ä½œæµä¼˜å…ˆçº§ï¼ˆä¸æ’åºï¼‰
ws_scheduler = ContentionAwareWorkflowSequencing(0.33, 0.33, 0.33)
ws_scheduler.run(dataset.workflows, dataset.vms)

# è®¿é—®ä¼˜å…ˆçº§
for workflow in dataset.workflows:
    print(f"å·¥ä½œæµ {workflow.id}: priority={workflow.workflow_priority:.4f}")
```

---

### ç¤ºä¾‹2ï¼šåŠ¨ä½œç©ºé—´å‰ªè£

```python
# åœ¨ç¯å¢ƒä¸­ï¼Œè·å–æ‰€æœ‰å°±ç»ªä»»åŠ¡
ready_tasks = []
for task_id, task_state in enumerate(env.state.task_states):
    if task_state.is_ready and task_state.assigned_vm_id is None:
        task = env.state.static_state.tasks[task_id]
        ready_tasks.append((task_id, task.global_priority))

# æŒ‰å…¨å±€ä¼˜å…ˆçº§æ’åºï¼ˆè¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
ready_tasks.sort(key=lambda x: x[1])

# é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„å‰Kä¸ªä»»åŠ¡
K = 5
top_k_tasks = ready_tasks[:K]

# ä»è¿™Kä¸ªä»»åŠ¡ä¸­éšæœºé€‰æ‹©
import random
selected_task_id, _ = random.choice(top_k_tasks)

# æ‰§è¡Œè°ƒåº¦åŠ¨ä½œ
action = EnvAction(task_id=selected_task_id, vm_id=selected_vm_id)
obs, reward, done, truncated, info = env.step(action)
```

---

### ç¤ºä¾‹3ï¼šä¼˜å…ˆçº§å¯è§†åŒ–

```python
import matplotlib.pyplot as plt

# æ”¶é›†æ‰€æœ‰ä»»åŠ¡çš„ä¼˜å…ˆçº§
all_priorities = []
for workflow in dataset.workflows:
    for task in workflow.tasks:
        all_priorities.append({
            'workflow_id': workflow.id,
            'task_id': task.id,
            'workflow_priority': workflow.workflow_priority,
            'rank_dp': task.rank_dp,
            'global_priority': task.global_priority
        })

# ç»˜åˆ¶å…¨å±€ä¼˜å…ˆçº§åˆ†å¸ƒ
priorities = [p['global_priority'] for p in all_priorities]
plt.hist(priorities, bins=50)
plt.xlabel('Global Priority')
plt.ylabel('Count')
plt.title('Task Global Priority Distribution')
plt.show()
```

---

### ç¤ºä¾‹4ï¼šæŒ‰ä¼˜å…ˆçº§æ’åºä»»åŠ¡

```python
# è·å–æ‰€æœ‰ä»»åŠ¡å¹¶æŒ‰å…¨å±€ä¼˜å…ˆçº§æ’åº
all_tasks = []
for workflow in dataset.workflows:
    for task in workflow.tasks:
        all_tasks.append(task)

# æ’åºï¼ˆä¼˜å…ˆçº§è¶Šå°è¶Šé«˜ï¼‰
all_tasks.sort(key=lambda t: t.global_priority)

# è¾“å‡ºå‰10ä¸ªæœ€é«˜ä¼˜å…ˆçº§ä»»åŠ¡
print("Top 10 highest priority tasks:")
for i, task in enumerate(all_tasks[:10]):
    print(f"{i+1}. Task {task.id} (workflow {task.workflow_id}): "
          f"global_priority={task.global_priority:.4f}")
```

---

## ğŸ” ä¼˜å…ˆçº§è®¡ç®—è¯¦è§£

### workflow_priorityï¼ˆå·¥ä½œæµä¼˜å…ˆçº§ï¼‰

**å…¬å¼**ï¼š
```
workflow_priority = Î±â‚ Ã— (st/max_st) + Î±â‚‚ Ã— (wl/max_wl) + Î±â‚ƒ Ã— (ct/max_ct)
```

**ç»„æˆ**ï¼š
- `st`: æ¾å¼›æ—¶é—´ = deadline - avg_eft
- `wl`: å·¥ä½œè´Ÿè½½ = Î£ task.length
- `ct`: ç«äº‰åº¦ = æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°

**é»˜è®¤æƒé‡**ï¼šÎ±â‚=0.33, Î±â‚‚=0.33, Î±â‚ƒ=0.33

**è¯­ä¹‰**ï¼šå€¼è¶Šå°ï¼Œå·¥ä½œæµä¼˜å…ˆçº§è¶Šé«˜

---

### rank_dpï¼ˆä»»åŠ¡ä¼˜å…ˆçº§ï¼‰

**å…¬å¼**ï¼š
```
rank_dp[task] = max(rank_dp[child]) + avg_worktime[task]
```

**è¯­ä¹‰**ï¼š
- è¡¨ç¤ºä»è¯¥ä»»åŠ¡åˆ°å‡ºå£ä»»åŠ¡çš„æœ€é•¿æ‰§è¡Œè·¯å¾„
- å€¼è¶Šå¤§ï¼Œä»»åŠ¡ä¼˜å…ˆçº§è¶Šé«˜

---

### global_priorityï¼ˆå…¨å±€ä»»åŠ¡ä¼˜å…ˆçº§ï¼‰

**å…¬å¼**ï¼š
```
global_priority = workflow_priority Ã— rank_dp
```

**è¯­ä¹‰**ï¼š
- ç»¼åˆè€ƒè™‘å·¥ä½œæµå’Œä»»åŠ¡ä¸¤ä¸ªå±‚é¢çš„ä¼˜å…ˆçº§
- å€¼è¶Šå°ï¼Œæ•´ä½“ä¼˜å…ˆçº§è¶Šé«˜
- ç”¨äºåœ¨æ‰€æœ‰å·¥ä½œæµçš„ä»»åŠ¡ä¸­æ¯”è¾ƒç›¸å¯¹ä¼˜å…ˆçº§

---

## âš ï¸ é‡è¦æç¤º

### ä¼˜å…ˆçº§æ–¹å‘

```python
# workflow_priority: è¶Šå°è¶Šé«˜
if wf1.workflow_priority < wf2.workflow_priority:
    print("wf1 ä¼˜å…ˆçº§æ›´é«˜")

# rank_dp: è¶Šå¤§è¶Šé«˜
if task1.rank_dp > task2.rank_dp:
    print("task1 ä¼˜å…ˆçº§æ›´é«˜ï¼ˆåœ¨åŒä¸€å·¥ä½œæµå†…ï¼‰")

# global_priority: è¶Šå°è¶Šé«˜
if task1.global_priority < task2.global_priority:
    print("task1 å…¨å±€ä¼˜å…ˆçº§æ›´é«˜")
```

### æ’åºæ–¹å¼

```python
# æŒ‰å·¥ä½œæµä¼˜å…ˆçº§æ’åºï¼ˆå‡åºï¼‰
workflows.sort(key=lambda wf: wf.workflow_priority)

# æŒ‰ä»»åŠ¡å…¨å±€ä¼˜å…ˆçº§æ’åºï¼ˆå‡åºï¼‰
tasks.sort(key=lambda t: t.global_priority)
```

---

## ğŸš€ å¸¸è§åº”ç”¨åœºæ™¯

### 1. Top-Kä»»åŠ¡é€‰æ‹©

```python
def select_top_k_tasks(env, K=5):
    """é€‰æ‹©ä¼˜å…ˆçº§æœ€é«˜çš„Kä¸ªå°±ç»ªä»»åŠ¡"""
    ready_tasks = [
        (task_id, env.state.static_state.tasks[task_id].global_priority)
        for task_id, task_state in enumerate(env.state.task_states)
        if task_state.is_ready and task_state.assigned_vm_id is None
    ]
    ready_tasks.sort(key=lambda x: x[1])
    return [task_id for task_id, _ in ready_tasks[:K]]
```

### 2. ä¼˜å…ˆçº§æ„ŸçŸ¥çš„å¥–åŠ±å‡½æ•°

```python
def compute_reward(obs, prev_obs):
    # åŸæœ‰å¥–åŠ±
    makespan_reward = -(obs.makespan() - prev_obs.makespan())
    energy_reward = -(obs.energy_consumption() - prev_obs.energy_consumption())
    
    # æ–°å¢ï¼šä¼˜å…ˆçº§å¥–åŠ±
    # ä¼˜å…ˆå®Œæˆé«˜ä¼˜å…ˆçº§ä»»åŠ¡ç»™äºˆé¢å¤–å¥–åŠ±
    priority_reward = 0
    for task_obs in obs.task_observations:
        if task_obs.assigned_vm_id is not None:
            # global_priorityè¶Šå°å¥–åŠ±è¶Šå¤§
            priority_reward += 1.0 / (task_obs.global_priority + 1e-6)
    
    return makespan_reward + energy_reward + 0.1 * priority_reward
```

### 3. æ™ºèƒ½åŠ¨ä½œå±è”½

```python
def get_valid_actions(env, percentile=90):
    """åªä¿ç•™é«˜ä¼˜å…ˆçº§ä»»åŠ¡çš„åŠ¨ä½œ"""
    ready_tasks = [
        (task_id, env.state.static_state.tasks[task_id].global_priority)
        for task_id, task_state in enumerate(env.state.task_states)
        if task_state.is_ready and task_state.assigned_vm_id is None
    ]
    
    if not ready_tasks:
        return []
    
    # è®¡ç®—ä¼˜å…ˆçº§é˜ˆå€¼ï¼ˆç¬¬90ç™¾åˆ†ä½ï¼‰
    priorities = [p for _, p in ready_tasks]
    threshold = np.percentile(priorities, percentile)
    
    # åªä¿ç•™ä¼˜å…ˆçº§é«˜äºé˜ˆå€¼çš„ä»»åŠ¡
    high_priority_tasks = [
        task_id for task_id, priority in ready_tasks
        if priority <= threshold  # æ³¨æ„ï¼šè¶Šå°è¶Šé«˜
    ]
    
    return high_priority_tasks
```

---

## ğŸ“Š éªŒè¯æ–¹æ³•

è¿è¡Œæµ‹è¯•è„šæœ¬ï¼š

```bash
cd paper1115
python test_priority_refactor.py
```

é¢„æœŸè¾“å‡ºï¼š
```
âœ… é€šè¿‡: WSç®—æ³•ä¸æ’åº
âœ… é€šè¿‡: å…¨å±€ä»»åŠ¡ä¼˜å…ˆçº§è®¡ç®—
âœ… é€šè¿‡: workflow_idä¸€è‡´æ€§
```

---

## ğŸ“ ç›¸å…³æ–‡æ¡£

- `å·¥ä½œæµä¼˜å…ˆçº§é‡æ„æ€»ç»“.md` - å®Œæ•´çš„é‡æ„è¯´æ˜
- `é¢„è°ƒåº¦åŠŸèƒ½å®ç°æ€»ç»“.md` - é¢„è°ƒåº¦ç®—æ³•è¯¦è§£
- `rank_dpå’Œdeadlineè¯¦è§£.md` - rank_dpçš„è¯¦ç»†è¯´æ˜

---

**æ›´æ–°æ—¥æœŸ**: 2025-10-26

