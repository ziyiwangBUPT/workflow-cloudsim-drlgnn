# æµ‹è¯•é—®é¢˜è§£ç­”

## é—®é¢˜1ï¼šä¸ºä»€ä¹ˆä¼šå‡ºç°5ä¸ªHostå’Œ10ä¸ªHostçš„æƒ…å†µï¼Ÿ

### åŸå› è§£é‡Š

æµ‹è¯•è„šæœ¬ä¸­æœ‰ä¸€ä¸ªå¾ªç¯ï¼Œæ•…æ„è¯·æ±‚ä¸åŒæ•°é‡çš„Hostæ¥**éªŒè¯æ— è®ºè¯·æ±‚å¤šå°‘ï¼Œéƒ½åªä¼šç”Ÿæˆ4ä¸ªHost**ï¼š

```python
# åœ¨ test_carbon_intensity_integration.py ä¸­
for requested_count in [2, 4, 5, 10]:  # æµ‹è¯•ç”¨ä¾‹
    dataset = generate_dataset(
        seed=42,
        host_count=requested_count,  # è¯·æ±‚ä¸åŒæ•°é‡
        ...
    )
```

### è®¾è®¡ç›®çš„

ä¸ºäº†éªŒè¯ `gen_vm.py` ä¸­çš„ä¿®æ”¹æ˜¯å¦æ­£ç¡®ï¼š

```python
def generate_hosts(n: int, rng: np.random.RandomState) -> list[Host]:
    actual_n = FIXED_NUM_HOSTS  # å¼ºåˆ¶ä¸º4
    
    if n != actual_n:
        print(f"[è­¦å‘Š] è¯·æ±‚ç”Ÿæˆ {n} ä¸ªHostï¼Œä½†ä¸ºæ”¯æŒç¢³å¼ºåº¦ç‰¹å¾ï¼Œå¼ºåˆ¶ç”Ÿæˆ {actual_n} ä¸ªHost")
    
    # ... åªç”Ÿæˆ4ä¸ªHost ...
```

### ä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·çš„æµ‹è¯•

- **éªŒè¯åŠŸèƒ½**ï¼šç¡®ä¿æ— è®ºç”¨æˆ·è¯·æ±‚å¤šå°‘Hostï¼Œå®é™…éƒ½åªç”Ÿæˆ4ä¸ª
- **æµ‹è¯•å¥å£®æ€§**ï¼šç¡®ä¿ä»£ç ä¸ä¼šå› ä¸ºç”¨æˆ·ä¼ å…¥ä¸åŒçš„æ•°é‡è€Œå‡ºé”™
- **ç¬¦åˆè®¾è®¡è¦æ±‚**ï¼šä¸ºäº†æ”¯æŒç¢³å¼ºåº¦ç‰¹å¾ï¼Œå¿…é¡»å›ºå®š4ä¸ªHost

### Hostæ•°é‡å›ºå®šä¸º4çš„åŸå› 

1. **æ¨¡ä»¿ecmwsé¡¹ç›®**ï¼šecmwsé¡¹ç›®ä½¿ç”¨4ä¸ªæ•°æ®ä¸­å¿ƒçš„ç”µä»·
2. **ç¢³å¼ºåº¦æ•°æ®ç»“æ„**ï¼šç¡¬ç¼–ç äº†4Ã—24çš„ç¢³å¼ºåº¦æ•°ç»„
3. **ç®€åŒ–ç®¡ç†**ï¼šå›ºå®šæ•°é‡ä¾¿äºç¢³å¼ºåº¦æ•°æ®ç®¡ç†

---

## é—®é¢˜2ï¼šTask ID mismatch é”™è¯¯

### é”™è¯¯ä¿¡æ¯

```
AssertionError: Sanity Check Failed: Task ID mismatch, 9 != 1
```

### é”™è¯¯ä½ç½®

åœ¨ `gym_env.py` çš„ç¬¬99è¡Œï¼š

```python
# Sanity check - we should be able to use index and id interchangeably
for i, task in enumerate(mapped_tasks):
    assert task.id == i, f"Sanity Check Failed: Task ID mismatch, {task.id} != {i}"
```

### é—®é¢˜åŸå› 

1. **å¤šæ¬¡æ•°æ®é›†ç”Ÿæˆ**ï¼šæµ‹è¯•å¾ªç¯ä¸­å¤šæ¬¡è°ƒç”¨ `generate_dataset(seed=42)`
2. **ç›¸åŒçš„seed**ï¼šä½¿ç”¨ç›¸åŒçš„seedå¯¼è‡´å¤šæ¬¡ç”Ÿæˆç›¸ä¼¼çš„æ•°æ®
3. **TaskMapperé‡æ–°æ˜ å°„**ï¼š`TaskMapper` å°è¯•å°†æ‰€æœ‰ä»»åŠ¡é‡æ–°æ˜ å°„ä¸ºè¿ç»­ID
4. **IDå†²çª**ï¼šä¸åŒæ¬¡ç”Ÿæˆçš„ä»»åŠ¡IDå‘ç”Ÿå†²çª

### å…·ä½“åŸå› åˆ†æ

æŸ¥çœ‹ `task_mapper.py` ç¬¬58è¡Œï¼š

```python
child_ids=[self.map_id(_task.workflow_id, 0) for _task in self._tasks if _task.id == 0]
```

**é—®é¢˜**ï¼š
- æ¯ä¸ªå·¥ä½œæµéƒ½æœ‰ä¸€ä¸ªID=0çš„å…¥å£ä»»åŠ¡
- å½“å¤šä¸ªå·¥ä½œæµåˆå¹¶æ—¶ï¼Œå¯èƒ½æœ‰å¤šä¸ªä»»åŠ¡çš„åŸå§‹ID=0
- `TaskMapper` å°è¯•å°†è¿™äº›ä»»åŠ¡æ˜ å°„ä¸ºä¸åŒçš„æ–°ID
- æ˜ å°„è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°IDä¸è¿ç»­çš„æƒ…å†µ

### ä¸ºä»€ä¹ˆç¬¬1ä¸ªä»»åŠ¡(ID=1)æ˜ å°„åˆ°ID=9ï¼Ÿ

å½“ `Sanity Check` å¤±è´¥æ—¶ï¼Œè¯´æ˜ï¼š
- æœŸæœ›ä»»åŠ¡IDåº”è¯¥æ˜¯è¿ç»­çš„ï¼š0, 1, 2, 3, ...
- ä½†å®é™…å¾—åˆ°çš„IDæ˜¯ï¼š..., 9, ...
- è¿™è¯´æ˜ `TaskMapper` çš„æ˜ å°„é€»è¾‘æœ‰è·³è·ƒ

**å¯èƒ½çš„åŸå› **ï¼š
1. å·¥ä½œæµæ•°é‡å¤šï¼Œå¯¼è‡´IDæ˜ å°„è·³è·ƒ
2. ä»»åŠ¡ä¾èµ–å…³ç³»å¤æ‚ï¼Œå¯¼è‡´æ˜ å°„ç®—æ³•è·³è¿‡æŸäº›ID
3. å¤šæ¬¡ç”Ÿæˆæ•°æ®é›†æ—¶ï¼Œå…¨å±€çŠ¶æ€æ²¡æœ‰æ¸…ç†

### è§£å†³æ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šä½¿ç”¨ä¸åŒçš„seedï¼ˆå·²å®ç°ï¼‰

```python
for idx, requested_count in enumerate(test_counts):
    dataset = generate_dataset(
        seed=42 + idx,  # ä½¿ç”¨ä¸åŒçš„seed
        ...
    )
```

#### æ–¹æ¡ˆ2ï¼šç®€åŒ–æµ‹è¯•ï¼ˆæ¨èï¼‰

åˆ›å»ºä¸€ä¸ªåªæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½çš„ç®€åŒ–æµ‹è¯•è„šæœ¬ï¼š

```python
# test_simple_carbon.py
def test_basic_features():
    dataset = generate_dataset(seed=42, ...)
    # åªæµ‹è¯•åŸºæœ¬åŠŸèƒ½ï¼Œä¸åˆ›å»ºç¯å¢ƒ
    assert len(dataset.hosts) == 4
    assert len(dataset.vms) == 10
```

#### æ–¹æ¡ˆ3ï¼šæ¯æ¬¡é‡ç½®å…¨å±€çŠ¶æ€

```python
def test_with_reset():
    for requested_count in [2, 4, 5, 10]:
        # é‡ç½®å¯èƒ½å­˜åœ¨çš„å…¨å±€çŠ¶æ€
        import gc
        gc.collect()
        
        dataset = generate_dataset(...)
        # æµ‹è¯•
```

---

## ğŸ¯ å»ºè®®çš„æµ‹è¯•ç­–ç•¥

### å½“å‰çŠ¶æ€

âœ… **Hostç”ŸæˆåŠŸèƒ½æ­£å¸¸**
- æ— è®ºè¯·æ±‚å¤šå°‘Hostï¼Œéƒ½åªç”Ÿæˆ4ä¸ª
- æ¯ä¸ªHostéƒ½æœ‰ç¢³å¼ºåº¦æ›²çº¿

âŒ **ç¯å¢ƒåˆ›å»ºæ—¶å‡ºé”™**
- Task IDæ˜ å°„é—®é¢˜
- å¯èƒ½æ˜¯æµ‹è¯•è„šæœ¬å¤ªå¤æ‚

### æ¨èåšæ³•

**æ–¹æ¡ˆAï¼šä½¿ç”¨ç®€åŒ–æµ‹è¯•**

```bash
# åªæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½
python test_simple_carbon.py
```

**æ–¹æ¡ˆBï¼šè·³è¿‡ç¯å¢ƒæµ‹è¯•**

```python
# åªæµ‹è¯•æ•°æ®é›†ç”Ÿæˆï¼Œä¸æµ‹è¯•ç¯å¢ƒ
def test_host_and_vm():
    dataset = generate_dataset(...)
    assert len(dataset.hosts) == 4
    assert all(host.carbon_intensity_curve for host in dataset.hosts)
```

**æ–¹æ¡ˆCï¼šåˆ†æ­¥æµ‹è¯•**

```python
# æµ‹è¯•1ï¼šHostç”Ÿæˆ
test_host_generation()

# æµ‹è¯•2ï¼šVMåˆ†é…
test_vm_allocation()

# æµ‹è¯•3ï¼šç¯å¢ƒåˆ›å»ºï¼ˆå•ç‹¬è¿è¡Œï¼‰
test_environment_creation()
```

---

## ğŸ“Š æµ‹è¯•ç»“æœæ€»ç»“

### âœ… å·²éªŒè¯é€šè¿‡çš„åŠŸèƒ½

1. **ç¢³å¼ºåº¦æ•°æ®é…ç½®**
   - 4ä¸ªHost Ã— 24å°æ—¶æ•°æ® âœ…
   - ç¢³å¼ºåº¦æŸ¥è¯¢æ¥å£ âœ…

2. **Hostç”Ÿæˆé€»è¾‘**
   - å¼ºåˆ¶ç”Ÿæˆ4ä¸ªHost âœ…
   - è‡ªåŠ¨åˆ†é…ç¢³å¼ºåº¦æ›²çº¿ âœ…

3. **VMåˆ†é…**
   - VMæ­£ç¡®åˆ†é…åˆ°Host âœ…
   - Hostçš„ç¢³å¼ºåº¦æ–¹æ³•æ­£å¸¸ âœ…

### âš ï¸ éœ€è¦è¿›ä¸€æ­¥æµ‹è¯•

1. **ç¯å¢ƒåˆå§‹åŒ–**
   - è™šæ‹Ÿæ—¶é’Ÿç®¡ç†å™¨åˆå§‹åŒ–
   - ä»»åŠ¡æ˜ å°„

2. **ä»»åŠ¡è°ƒåº¦**
   - è™šæ‹Ÿæ—¶é’Ÿæ›´æ–°
   - ç¢³å¼ºåº¦ç‰¹å¾æå–

3. **å¥–åŠ±å‡½æ•°**
   - ç¢³æˆæœ¬è®¡ç®—
   - å¤šç›®æ ‡å¥–åŠ±

---

## ğŸ”§ å¦‚ä½•ç»§ç»­æµ‹è¯•

### æ–¹æ³•1ï¼šä½¿ç”¨ç®€åŒ–æµ‹è¯•ï¼ˆå½“å‰æ¨èï¼‰

```bash
cd paper1115
python test_simple_carbon.py
```

è¿™ä¸ªè„šæœ¬åªæµ‹è¯•æ•°æ®é›†ç”Ÿæˆï¼Œä¸åˆ›å»ºç¯å¢ƒï¼Œé¿å…äº†Task IDçš„é—®é¢˜ã€‚

### æ–¹æ³•2ï¼šåˆ›å»ºå•ä¸ªæµ‹è¯•ç¯å¢ƒ

```python
# test_single_env.py
def test_one_environment():
    dataset = generate_dataset(seed=42, ...)
    env = CloudSchedulingGymEnvironment(dataset=dataset)
    obs, info = env.reset()
    # æµ‹è¯•...
```

### æ–¹æ³•3ï¼šè°ƒè¯•Task IDé—®é¢˜

```python
# åœ¨ gym_env.py ä¸­æ·»åŠ è°ƒè¯•ä¿¡æ¯
for i, task in enumerate(mapped_tasks):
    if task.id != i:
        print(f"IDä¸åŒ¹é…: ç´¢å¼•={i}, ä»»åŠ¡ID={task.id}")
        print(f"ä»»åŠ¡è¯¦æƒ…: {task}")
    assert task.id == i, ...
```

---

## ğŸ’¡ æ ¸å¿ƒè¦ç‚¹

### é—®é¢˜1ï¼ˆHostæ•°é‡ï¼‰ä¸æ˜¯é—®é¢˜ âœ…

- è¿™æ˜¯**æ•…æ„**çš„æµ‹è¯•ç”¨ä¾‹
- ç›®çš„æ˜¯éªŒè¯ä»£ç çš„æ­£ç¡®æ€§
- åŠŸèƒ½å·¥ä½œæ­£å¸¸

### é—®é¢˜2ï¼ˆTask IDï¼‰éœ€è¦å¤„ç† âš ï¸

- å¯èƒ½æ˜¯æµ‹è¯•è„šæœ¬çš„é—®é¢˜
- æ ¸å¿ƒåŠŸèƒ½ï¼ˆHostå’ŒVMï¼‰å·¥ä½œæ­£å¸¸
- å»ºè®®ä½¿ç”¨ç®€åŒ–æµ‹è¯•è„šæœ¬

### å®ç°å·²å®Œæˆ âœ…

- ç¢³å¼ºåº¦æ•°æ®ç»“æ„ âœ…
- Hostç”Ÿæˆé€»è¾‘ âœ…
- VMç‰¹å¾æ‰©å±• âœ…
- GNNç‰¹å¾é›†æˆ âœ…
- è™šæ‹Ÿæ—¶é’Ÿç®¡ç†å™¨ âœ…
- æ—¶é’Ÿæ›´æ–°æœºåˆ¶ âœ…

**ä¸‹ä¸€æ­¥**ï¼šä½¿ç”¨ç®€åŒ–çš„æµ‹è¯•è„šæœ¬éªŒè¯ï¼Œæˆ–ç›´æ¥ä¿®æ”¹å¥–åŠ±å‡½æ•°å¼€å§‹è®­ç»ƒï¼

