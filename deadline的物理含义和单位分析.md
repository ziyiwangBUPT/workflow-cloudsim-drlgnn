# deadline çš„ç‰©ç†å«ä¹‰å’Œå•ä½åˆ†æ

## ğŸ”¬ å•ä½è¿½è¸ªé“¾æ¡

è®©æˆ‘ä»æºå¤´è¿½è¸ª `deadline` çš„è®¡ç®—è¿‡ç¨‹ï¼Œç¡®å®šå…¶ç‰©ç†æ„ä¹‰ï¼š

---

### ç¬¬ 1 æ­¥ï¼šåŸºç¡€ç‰©ç†é‡

#### Task.lengthï¼ˆä»»åŠ¡è®¡ç®—é‡ï¼‰
```python
task.length: int  # å•ä½ï¼šMI (Million Instructionsï¼Œç™¾ä¸‡æ¡æŒ‡ä»¤)
```
- **ç‰©ç†å«ä¹‰**ï¼šä»»åŠ¡éœ€è¦æ‰§è¡Œçš„æŒ‡ä»¤æ€»æ•°
- **å…¸å‹å€¼**ï¼š100 ~ 1000 MIï¼ˆåœ¨æµ‹è¯•ä¸­ï¼‰

#### VM.cpu_speed_mipsï¼ˆè™šæ‹ŸæœºCPUé€Ÿåº¦ï¼‰
```python
vm.cpu_speed_mips: int  # å•ä½ï¼šMIPS (Million Instructions Per Secondï¼Œæ¯ç§’ç™¾ä¸‡æ¡æŒ‡ä»¤)
```
- **ç‰©ç†å«ä¹‰**ï¼šè™šæ‹Ÿæœºæ¯ç§’èƒ½æ‰§è¡Œçš„æŒ‡ä»¤æ•°
- **å…¸å‹å€¼**ï¼š1000 ~ 3000 MIPSï¼ˆåœ¨æµ‹è¯•ä¸­ï¼‰

---

### ç¬¬ 2 æ­¥ï¼šå¹³å‡æ‰§è¡Œæ—¶é—´è®¡ç®—

#### compute_avg_speed()
```python
avg_speed = sum(vm.cpu_speed_mips for vm in vms) / len(vms)
# å•ä½ï¼šMIPS
```
- **ç‰©ç†å«ä¹‰**ï¼šæ‰€æœ‰è™šæ‹Ÿæœºçš„å¹³å‡å¤„ç†é€Ÿåº¦
- **ç¤ºä¾‹**ï¼šå¦‚æœæœ‰ 10 ä¸ª VMï¼Œé€Ÿåº¦åˆ†åˆ«ä¸º 1000~3000 MIPSï¼Œå¹³å‡çº¦ 2000 MIPS

#### estimate_task_avg_work_time()
```python
task_avg_worktime[task.id] = task.length / avg_speed
# å•ä½ï¼šMI / MIPS = MI / (MI/s) = ç§’ (s)
```

**å•ä½æ¢ç®—**ï¼š
```
task.length (MI) Ã· avg_speed (MI/s) = æ‰§è¡Œæ—¶é—´ (s)

ä¾‹å¦‚ï¼š
500 MI Ã· 2000 MIPS = 0.25 ç§’
```

âœ… **ç»“è®º**ï¼š`task_avg_worktime` æ˜¯**çœŸå®çš„ç‰©ç†æ—¶é—´**ï¼Œå•ä½æ˜¯**ç§’(s)**

---

### ç¬¬ 3 æ­¥ï¼šä»»åŠ¡çš„å¹³å‡æœ€æ—©å®Œæˆæ—¶é—´

#### estimate_task_avg_eft()
```python
task.avg_est = max(parent.avg_eft for parent in parents) or workflow.arrival_time
task.avg_eft = task.avg_est + task_avg_worktime[task.id]
# å•ä½ï¼šç§’ (s)
```

**ç‰©ç†å«ä¹‰**ï¼š
- `task.avg_est`ï¼šä»»åŠ¡åœ¨å¹³å‡èµ„æºä¸Šçš„**æœ€æ—©å¼€å§‹æ—¶é—´**ï¼ˆç›¸å¯¹äºå·¥ä½œæµå¼€å§‹ï¼‰
- `task.avg_eft`ï¼šä»»åŠ¡åœ¨å¹³å‡èµ„æºä¸Šçš„**æœ€æ—©å®Œæˆæ—¶é—´**ï¼ˆç›¸å¯¹äºå·¥ä½œæµå¼€å§‹ï¼‰

âœ… **ç»“è®º**ï¼š`task.avg_eft` æ˜¯**çœŸå®çš„ç‰©ç†æ—¶é—´**ï¼Œå•ä½æ˜¯**ç§’(s)**

---

### ç¬¬ 4 æ­¥ï¼šå·¥ä½œæµçš„æˆªæ­¢æ—¶é—´

#### precompute_workflow_data()
```python
workflow.avg_eft = max(task.avg_eft for task in workflow.tasks)
# å•ä½ï¼šç§’ (s)

workflow.deadline = workflow.avg_eft * (1 + rho)
# å•ä½ï¼šç§’ (s)
```

**ç‰©ç†å«ä¹‰**ï¼š
- `workflow.avg_eft`ï¼šå·¥ä½œæµåœ¨å¹³å‡èµ„æºä¸Šçš„**é¢„è®¡å®Œæˆæ—¶é—´**
- `rho`ï¼š**æ¾å¼›å› å­**ï¼ˆæ— é‡çº²ï¼Œé€šå¸¸ 0.2 è¡¨ç¤ºç•™ 20% çš„æ—¶é—´ä½™é‡ï¼‰
- `workflow.deadline`ï¼šå·¥ä½œæµçš„**æ€»æˆªæ­¢æ—¶é—´**

**ç¤ºä¾‹**ï¼š
```
å¦‚æœ workflow.avg_eft = 1.0 ç§’ï¼Œrho = 0.2
åˆ™ workflow.deadline = 1.0 * (1 + 0.2) = 1.2 ç§’
```

âœ… **ç»“è®º**ï¼š`workflow.deadline` æ˜¯**çœŸå®çš„ç‰©ç†æ—¶é—´**ï¼Œå•ä½æ˜¯**ç§’(s)**

---

### ç¬¬ 5 æ­¥ï¼šä»»åŠ¡çš„å­æˆªæ­¢æ—¶é—´ï¼ˆæœ€ç»ˆç»“æœï¼‰

#### compute_sub_deadlines()
```python
rank_dp_0 = max(rank_dp[entry_task])  # å•ä½ï¼šç§’ (s)
rank_dp[task]                          # å•ä½ï¼šç§’ (s)
task_avg_worktime[task]                # å•ä½ï¼šç§’ (s)

task.deadline = workflow.deadline * (rank_dp_0 - rank_dp[task] + task_avg_worktime[task]) / rank_dp_0
# å•ä½ï¼šç§’ * (ç§’ - ç§’ + ç§’) / ç§’ = ç§’ (s)
```

**å•ä½éªŒè¯**ï¼š
```
[ç§’] * ([ç§’] - [ç§’] + [ç§’]) / [ç§’] = [ç§’] * [æ— é‡çº²] = [ç§’]
```

âœ… **æœ€ç»ˆç»“è®º**ï¼š`task.deadline` æ˜¯**çœŸå®çš„ç‰©ç†æ—¶é—´**ï¼Œå•ä½æ˜¯**ç§’(s)**

---

## ğŸ“Š å®é™…æµ‹è¯•æ•°æ®éªŒè¯

ä»æµ‹è¯•è¾“å‡ºï¼š
```
å·¥ä½œæµ 2: avg_eft=0.71, workload=3241.00, deadline=0.86

ä»»åŠ¡ 0:
   - length: 509 MI
   - avg_eft: 0.25 ç§’
   - deadline: 0.30 ç§’
```

**éªŒè¯è®¡ç®—**ï¼š
```
å‡è®¾ avg_speed = 2000 MIPS

ä»»åŠ¡æ‰§è¡Œæ—¶é—´ = 509 MI / 2000 MIPS = 0.2545 ç§’ â‰ˆ 0.25 ç§’ âœ“

å·¥ä½œæµæˆªæ­¢æ—¶é—´ = 0.71 * (1 + 0.2) = 0.852 ç§’ â‰ˆ 0.86 ç§’ âœ“
```

---

## ğŸ¯ ç‰©ç†å«ä¹‰æ€»ç»“

### deadline çš„å®Œæ•´ç‰©ç†å«ä¹‰

`task.deadline` è¡¨ç¤ºï¼š
> **ä»å·¥ä½œæµå¼€å§‹æ‰§è¡Œï¼ˆt=0ï¼‰åˆ°ä»»åŠ¡å¿…é¡»å®Œæˆçš„æ—¶é—´ç‚¹ï¼Œå•ä½æ˜¯ç§’**

æ›´å…·ä½“åœ°è¯´ï¼š
1. **å‚è€ƒæ—¶é—´ç‚¹**ï¼šå·¥ä½œæµçš„ `arrival_time`ï¼ˆåˆ°è¾¾æ—¶é—´ï¼‰
2. **ç»å¯¹æ—¶é—´**ï¼šå¦‚æœå·¥ä½œæµåœ¨ t=10 ç§’åˆ°è¾¾ï¼Œä»»åŠ¡ deadline=0.30 ç§’ï¼Œåˆ™ä»»åŠ¡å¿…é¡»åœ¨ t=10.30 ç§’å‰å®Œæˆ
3. **ç›¸å¯¹æ—¶é—´**ï¼šåœ¨ä»£ç å®ç°ä¸­ï¼Œdeadline æ˜¯ç›¸å¯¹äºå·¥ä½œæµå¼€å§‹çš„**ç›¸å¯¹æ—¶é—´æˆ³**

### ä¸çœŸå®è°ƒåº¦çš„å…³ç³»

åœ¨ `gym_env.py` ä¸­ï¼Œä»»åŠ¡çš„å®é™…æ‰§è¡Œæ—¶é—´è®¡ç®—ï¼š

```python
processing_time = task.length / vm.cpu_speed_mips  # ç§’
completion_time = start_time + processing_time     # ç§’
```

**å¯¹æ¯”æ£€æŸ¥**ï¼š
```python
if task.completion_time > task.deadline:
    # ä»»åŠ¡è¶…æœŸï¼éœ€è¦æƒ©ç½š
    tardiness = task.completion_time - task.deadline  # å•ä½ï¼šç§’
```

---

## ğŸ” deadline ä¸æ˜¯å½’ä¸€åŒ–æ—¶é—´ï¼

### ä¸ºä»€ä¹ˆçœ‹èµ·æ¥åƒå½’ä¸€åŒ–ï¼Ÿ

åœ¨æµ‹è¯•ä¸­çœ‹åˆ°çš„å€¼ï¼ˆ0.30, 0.86ï¼‰**å¾ˆå°**ï¼Œæ˜¯å› ä¸ºï¼š

1. **ä»»åŠ¡è®¡ç®—é‡å°**ï¼š100~1000 MI
2. **CPU é€Ÿåº¦å¿«**ï¼š1000~3000 MIPS
3. **å®é™…æ‰§è¡Œæ—¶é—´çŸ­**ï¼š0.1~1 ç§’

**å¦‚æœæ¢æˆçœŸå®åœºæ™¯**ï¼š
```python
# å¤§å‹ä»»åŠ¡
task.length = 10,000,000 MI (ä¸€åƒä¸‡æ¡æŒ‡ä»¤)
vm.cpu_speed_mips = 1000 MIPS

æ‰§è¡Œæ—¶é—´ = 10,000,000 / 1000 = 10,000 ç§’ = 2.78 å°æ—¶

å¦‚æœ workflow.deadline = 12,000 ç§’
åˆ™ task.deadline å¯èƒ½æ˜¯ 3000 ç§’ = 50 åˆ†é’Ÿ
```

---

## ğŸ“ æ•°å­¦ç‰©ç†æ¨¡å‹

### å®Œæ•´çš„æ—¶é—´æ¨¡å‹

```
æ—¶é—´è½´ï¼ˆç§’ï¼‰ï¼š
|-------------------|-------------------|-------------------|
0                task.deadline      task.avg_eft    workflow.deadline
â†‘                    â†‘                   â†‘                 â†‘
å·¥ä½œæµå¼€å§‹        ä»»åŠ¡åº”å®Œæˆæ—¶é—´    ä»»åŠ¡é¢„è®¡å®Œæˆ    å·¥ä½œæµåº”å®Œæˆæ—¶é—´
```

### å…³é”®ä¸ç­‰å¼

**ç†æƒ³æƒ…å†µ**ï¼š
```
task.avg_est â‰¤ task.start_time â‰¤ task.deadline â‰¤ workflow.deadline
```

**è¶…æœŸæƒ…å†µ**ï¼š
```
task.completion_time > task.deadline  â†’ äº§ç”Ÿå»¶è¿Ÿ (tardiness)
tardiness = task.completion_time - task.deadline  (ç§’)
```

---

## ğŸ’¡ åœ¨ PPO ä¸­çš„ä½¿ç”¨å»ºè®®

### æ–¹æ¡ˆ 1ï¼šç›´æ¥ä½¿ç”¨ï¼ˆé€‚åˆå•ä¸€å·¥ä½œè´Ÿè½½ï¼‰
```python
# å¦‚æœæ‰€æœ‰ä»»åŠ¡çš„æ—¶é—´å°ºåº¦ç›¸è¿‘ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
urgency = (task.deadline - current_time)  # å‰©ä½™æ—¶é—´ï¼ˆç§’ï¼‰
if urgency < 0.1:  # å°‘äº 0.1 ç§’
    priority = HIGH
```

### æ–¹æ¡ˆ 2ï¼šå½’ä¸€åŒ–ï¼ˆæ¨èï¼Œé€‚åˆå¤šæ ·åŒ–å·¥ä½œè´Ÿè½½ï¼‰
```python
# å½’ä¸€åŒ–åˆ° [0, 1] åŒºé—´ï¼Œä¾¿äºç¥ç»ç½‘ç»œå¤„ç†
normalized_deadline = task.deadline / workflow.deadline
normalized_remaining = (task.deadline - current_time) / workflow.deadline

# ä½œä¸ºç¥ç»ç½‘ç»œè¾“å…¥
state_features = [
    normalized_deadline,       # 0~1
    normalized_remaining,      # å¯èƒ½ä¸ºè´Ÿï¼ˆå·²è¶…æœŸï¼‰
    task.rank_dp / max_rank_dp,
    # ...
]
```

### æ–¹æ¡ˆ 3ï¼šè½¬æ¢ä¸ºç´§è¿«åº¦ï¼ˆæ¨èï¼‰
```python
# è®¡ç®—ç›¸å¯¹ç´§è¿«åº¦ï¼ˆæ— é‡çº²ï¼‰
slack_time = task.deadline - current_time - task.remaining_worktime
urgency_ratio = task.remaining_worktime / max(slack_time, 0.001)
# urgency_ratio > 1 è¡¨ç¤ºæ—¶é—´ä¸å¤Ÿ
# urgency_ratio < 1 è¡¨ç¤ºæ—¶é—´å……è£•
```

---

## ğŸ“ æ€»ç»“

| å±æ€§ | å•ä½ | ç‰©ç†å«ä¹‰ | æ˜¯å¦å½’ä¸€åŒ– | å…¸å‹å€¼ï¼ˆæµ‹è¯•ï¼‰ | å…¸å‹å€¼ï¼ˆçœŸå®ï¼‰ |
|-----|------|---------|-----------|--------------|--------------|
| `task.length` | MI | ä»»åŠ¡è®¡ç®—é‡ | âŒ åŸå§‹å€¼ | 100~1000 | 10^6~10^9 |
| `vm.cpu_speed_mips` | MIPS | CPUé€Ÿåº¦ | âŒ åŸå§‹å€¼ | 1000~3000 | 1000~10000 |
| `task_avg_worktime` | ç§’ | é¢„è®¡æ‰§è¡Œæ—¶é—´ | âŒ çœŸå®æ—¶é—´ | 0.1~0.5 | 10~10000 |
| `task.avg_eft` | ç§’ | é¢„è®¡å®Œæˆæ—¶é—´ | âŒ çœŸå®æ—¶é—´ | 0.25~1.5 | 100~50000 |
| `workflow.deadline` | ç§’ | å·¥ä½œæµæˆªæ­¢ | âŒ çœŸå®æ—¶é—´ | 0.86~1.68 | 1000~100000 |
| **`task.deadline`** | **ç§’** | **ä»»åŠ¡æˆªæ­¢æ—¶é—´** | **âŒ çœŸå®æ—¶é—´** | **0.30~0.86** | **500~50000** |
| `task.rank_dp` | ç§’ | å…³é”®è·¯å¾„é•¿åº¦ | âŒ çœŸå®æ—¶é—´ | 0.21~0.71 | 50~50000 |

**æ ¸å¿ƒç»“è®º**ï¼š
1. âœ… `deadline` æ˜¯**çœŸå®çš„ç‰©ç†æ—¶é—´**ï¼Œå•ä½æ˜¯**ç§’(s)**
2. âœ… ä¸æ˜¯å½’ä¸€åŒ–æ—¶é—´ï¼Œä¸æ˜¯ç™¾åˆ†æ¯”
3. âœ… å¯ä»¥ç›´æ¥ä¸ `current_time`, `completion_time` æ¯”è¾ƒ
4. âš ï¸ åœ¨ PPO è®­ç»ƒä¸­**å»ºè®®å½’ä¸€åŒ–**åå†è¾“å…¥ç¥ç»ç½‘ç»œ

